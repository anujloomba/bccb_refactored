<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>No Service Worker Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .debug { background: #e7f3ff; border: 1px solid #b8daff; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .match { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px; cursor: pointer; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèè No Service Worker Test</h1>
        <div id="output">
            <div class="debug">Ready to test...</div>
        </div>
        <button class="btn" onclick="runTest()">üîÑ Run Test</button>
        <button class="btn" onclick="clearOutput()">üóëÔ∏è Clear</button>
    </div>

    <script>
        // Explicitly disable service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister().then(() => {
                        console.log('Service Worker unregistered');
                    });
                }
            });
        }

        function log(message, type = 'debug') {
            const output = document.getElementById('output');
            output.innerHTML += `<div class="${type}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '<div class="debug">Output cleared...</div>';
        }

        function getPlayerNameFromId(playerId, playerInfo) {
            if (!playerId || !playerInfo) return 'Unknown';
            
            if (Array.isArray(playerInfo)) {
                const player = playerInfo.find(p => p.Player_ID === playerId);
                return player ? (player.Name || player.name) : playerId;
            } else {
                const player = playerInfo[playerId];
                return player ? (player.Name || player.name) : playerId;
            }
        }

        async function runTest() {
            log('üöÄ Starting comprehensive test...', 'debug');

            try {
                // Step 1: Test basic fetch
                log('üì° Step 1: Testing basic fetch...', 'debug');
                const response = await fetch('./cricket_stats.json?' + Math.random(), {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                log(`üì° Response: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // Step 2: Parse JSON
                log('üìä Step 2: Parsing JSON...', 'debug');
                const data = await response.json();
                log(`‚úÖ JSON parsed - Keys: ${Object.keys(data).join(', ')}`, 'success');

                // Step 3: Check data structure
                log('üîç Step 3: Analyzing data structure...', 'debug');
                log(`Player info: ${Array.isArray(data.player_info) ? 'Array with ' + data.player_info.length + ' items' : 'Object'}`, 'debug');
                log(`Matches: ${data.matches ? data.matches.length : 'none'}`, 'debug');
                log(`History: ${data.history ? data.history.length : 'none'}`, 'debug');

                // Step 4: Process matches
                const matchesData = data.matches || data.history || [];
                if (matchesData.length === 0) {
                    log('‚ùå No matches found!', 'error');
                    return;
                }

                log(`‚úÖ Found ${matchesData.length} matches`, 'success');

                // Step 5: Display first match as test
                const firstMatch = matchesData[0];
                log('üéØ Step 5: Processing first match...', 'debug');
                log(`Match ID: ${firstMatch.Match_ID}`, 'debug');
                log(`Team1: ${firstMatch.Team1} (Captain: ${firstMatch.Team1_Captain})`, 'debug');
                log(`Team2: ${firstMatch.Team2} (Captain: ${firstMatch.Team2_Captain})`, 'debug');
                log(`Winner: ${firstMatch.Winning_Team}`, 'debug');

                // Test name resolution
                const team1Captain = getPlayerNameFromId(firstMatch.Team1_Captain, data.player_info);
                const team2Captain = getPlayerNameFromId(firstMatch.Team2_Captain, data.player_info);
                log(`Captain names: ${team1Captain} vs ${team2Captain}`, 'debug');

                // Determine winner
                let winningCaptain, losingCaptain;
                if (firstMatch.Winning_Team === firstMatch.Team1) {
                    winningCaptain = team1Captain;
                    losingCaptain = team2Captain;
                } else {
                    winningCaptain = team2Captain;
                    losingCaptain = team1Captain;
                }

                log(`‚úÖ Final result: ${winningCaptain} vs ${losingCaptain}`, 'success');

                // Step 6: Display all matches
                log('üìã Step 6: Displaying all matches...', 'debug');
                matchesData.forEach((match, index) => {
                    const team1Capt = getPlayerNameFromId(match.Team1_Captain, data.player_info);
                    const team2Capt = getPlayerNameFromId(match.Team2_Captain, data.player_info);
                    
                    let winner, loser;
                    if (match.Winning_Team === match.Team1) {
                        winner = team1Capt;
                        loser = team2Capt;
                    } else {
                        winner = team2Capt;
                        loser = team1Capt;
                    }

                    const matchDate = new Date(match.Date || match.Date_Saved).toLocaleDateString();
                    
                    log(`<div class="match">
                        <strong>${match.Match_ID}</strong> - ${matchDate}<br>
                        <strong>Teams:</strong> ${winner} vs ${loser}<br>
                        <strong>Result:</strong> ${match.Result || (match.Winning_Team + ' won')}<br>
                        <strong>Score:</strong> ${match.Winning_Team_Score || 'N/A'} vs ${match.Losing_Team_Score || 'N/A'}
                    </div>`, 'success');
                });

                log('üéâ Test completed successfully!', 'success');

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }

        // Auto-run test
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runTest, 500);
        });
    </script>
</body>
</html>
