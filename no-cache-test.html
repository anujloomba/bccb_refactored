<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cricket Match History - No Cache</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug { 
            background: #f0f8ff; 
            padding: 10px; 
            margin: 10px 0; 
            border-left: 4px solid #007bff; 
            font-family: monospace;
            font-size: 12px;
        }
        .match-item { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 4px;
            background: #fafafa;
        }
        .error { color: red; }
        .success { color: green; }
        .no-matches {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèè Cricket Match History Test (No Cache)</h1>
        <div class="debug" id="debug">Starting debug log...</div>
        <hr>
        <div id="matchHistoryContainer">
            <div class="no-matches">Loading...</div>
        </div>
    </div>

    <script>
        // Add cache busting to prevent service worker issues
        const timestamp = new Date().getTime();
        
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }

        // Helper function to get player name from Player_ID
        function getPlayerNameFromId(playerId, playerInfo) {
            if (!playerId || !playerInfo) return 'Unknown';
            
            // Handle both object format {P001: {name: "..."}} and array format [{Player_ID: "P001", Name: "..."}]
            if (Array.isArray(playerInfo)) {
                const player = playerInfo.find(p => p.Player_ID === playerId);
                return player ? (player.Name || player.name) : playerId;
            } else {
                // Object format
                const player = playerInfo[playerId];
                return player ? (player.Name || player.name) : playerId;
            }
        }

        function displayMatchHistory(data, historyContainer) {
            debugLog('üéØ Processing match history data...');
            
            // Handle both new format (matches) and legacy format (history)
            const matchesData = data.matches || data.history || [];
            
            if (!data || matchesData.length === 0) {
                historyContainer.innerHTML = '<div class="no-matches">‚ùå No match history available</div>';
                debugLog('‚ö†Ô∏è No match data found');
                return;
            }

            debugLog(`üìã Found ${matchesData.length} matches in data`);

            // Sort matches by date (newest first)
            const sortedMatches = matchesData.sort((a, b) => {
                const dateA = new Date(a.Date || a.Date_Saved);
                const dateB = new Date(b.Date || b.Date_Saved);
                return dateB - dateA;
            });

            historyContainer.innerHTML = sortedMatches.map((match, index) => {
                debugLog(`üîç Processing match ${index + 1}: ${match.Match_ID}`);
                
                // Handle both formats
                const matchDate = match.Date || match.Date_Saved;
                const date = new Date(matchDate);
                const formattedDate = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                // Handle new format vs legacy format
                let winningCaptain, losingCaptain, winningTeamScore, losingTeamScore;
                let matchResult;
                
                if (match.Team1 && match.Team2) {
                    // New format
                    winningCaptain = match.Winning_Team;
                    losingCaptain = match.Losing_Team;
                    winningTeamScore = match.Winning_Team_Score || 'N/A';
                    losingTeamScore = match.Losing_Team_Score || 'N/A';
                    matchResult = match.Result || `${winningCaptain} won`;
                    
                    // Try to get captain names
                    if (match.Team1_Captain && match.Team2_Captain) {
                        const team1Captain = getPlayerNameFromId(match.Team1_Captain, data.player_info);
                        const team2Captain = getPlayerNameFromId(match.Team2_Captain, data.player_info);
                        winningCaptain = match.Winning_Team === match.Team1 ? team1Captain : team2Captain;
                        losingCaptain = match.Losing_Team === match.Team1 ? team1Captain : team2Captain;
                    }
                } else {
                    // Legacy format
                    winningCaptain = match.Winning_Captain || 'Unknown';
                    losingCaptain = match.Losing_Captain || 'Unknown';
                    winningTeamScore = match.Winning_Team_Score || 'N/A';
                    losingTeamScore = match.Losing_Team_Score || 'N/A';
                    
                    // Calculate margin for legacy format
                    const winningScoreParts = (winningTeamScore || '0/0').split('/');
                    const losingScoreParts = (losingTeamScore || '0/0').split('/');
                    const winningScore = parseInt(winningScoreParts[0]) || 0;
                    const losingScore = parseInt(losingScoreParts[0]) || 0;
                    const margin = winningScore - losingScore;
                    matchResult = `${winningCaptain}'s Team won by ${margin} runs`;
                }

                return `
                    <div class="match-item">
                        <h4>${match.Match_ID} - ${formattedDate}</h4>
                        <p><strong>Teams:</strong> ${winningCaptain} vs ${losingCaptain}</p>
                        <p><strong>Result:</strong> ${matchResult}</p>
                        <p><strong>Score:</strong> ${winningTeamScore} vs ${losingTeamScore}</p>
                        <p><strong>Venue:</strong> ${match.Venue || 'N/A'}</p>
                    </div>
                `;
            }).join('');

            debugLog('‚úÖ Match history display completed');
        }

        function loadMatchHistory() {
            const historyContainer = document.getElementById('matchHistoryContainer');
            debugLog(`üèè Loading match history... Container found: ${!!historyContainer}`);
            
            if (!historyContainer) {
                debugLog('‚ùå No history container found!');
                return;
            }

            // Add cache busting to the URL
            const url = `./cricket_stats.json?_=${timestamp}`;
            debugLog(`üì° Fetching: ${url}`);

            fetch(url, {
                cache: 'no-cache',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
                .then(response => {
                    debugLog(`üì° Response received: ${response.status} ${response.statusText}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    debugLog('üìä Data loaded successfully');
                    debugLog(`üìä Data structure: ${Object.keys(data).join(', ')}`);
                    debugLog(`üìä Matches: ${data.matches ? data.matches.length : 'none'}`);
                    debugLog(`üìä History: ${data.history ? data.history.length : 'none'}`);
                    debugLog(`üìä Player info: ${data.player_info ? (Array.isArray(data.player_info) ? 'array with ' + data.player_info.length + ' items' : 'object') : 'none'}`);
                    
                    displayMatchHistory(data, historyContainer);
                })
                .catch(error => {
                    debugLog(`‚ùå Error loading cricket_stats.json: ${error.message}`);
                    historyContainer.innerHTML = '<div class="error">‚ùå Error loading match history: ' + error.message + '</div>';
                });
        }

        // Load when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('üöÄ DOM loaded, starting match history load...');
            setTimeout(() => {
                loadMatchHistory();
            }, 500);
        });
    </script>
</body>
</html>
